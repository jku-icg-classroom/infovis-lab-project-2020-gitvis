
let debugIndex = 0;
const debugData = [
    {
        "sha": "8080598b181530e6402ba6f2dede69d11ef1b4e8",
        "node_id": "MDY6Q29tbWl0NDk3MTcxMzo4MDgwNTk4YjE4MTUzMGU2NDAyYmE2ZjJkZWRlNjlkMTFlZjFiNGU4",
        "commit": {
            "author": {
                "name": "Dietmar Angerer",
                "email": "uab.katzinger@gmail.com",
                "date": "2020-04-30T10:10:23Z"
            },
            "committer": {
                "name": "Dietmar Angerer",
                "email": "uab.katzinger@gmail.com",
                "date": "2020-04-30T10:10:23Z"
            },
            "message": "wordings",
            "tree": {
                "sha": "c36632987bbc1176feb85277b7c27262c03a43fc",
                "url": "https://api.github.com/repos/gtn/exacomp/git/trees/c36632987bbc1176feb85277b7c27262c03a43fc"
            },
            "url": "https://api.github.com/repos/gtn/exacomp/git/commits/8080598b181530e6402ba6f2dede69d11ef1b4e8",
            "comment_count": 0,
            "verification": {
                "verified": false,
                "reason": "unsigned",
                "signature": null,
                "payload": null
            }
        },
        "url": "https://api.github.com/repos/gtn/exacomp/commits/8080598b181530e6402ba6f2dede69d11ef1b4e8",
        "html_url": "https://github.com/gtn/exacomp/commit/8080598b181530e6402ba6f2dede69d11ef1b4e8",
        "comments_url": "https://api.github.com/repos/gtn/exacomp/commits/8080598b181530e6402ba6f2dede69d11ef1b4e8/comments",
        "author": {
            "login": "dangerer",
            "id": 1820610,
            "node_id": "MDQ6VXNlcjE4MjA2MTA=",
            "avatar_url": "https://avatars2.githubusercontent.com/u/1820610?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/dangerer",
            "html_url": "https://github.com/dangerer",
            "followers_url": "https://api.github.com/users/dangerer/followers",
            "following_url": "https://api.github.com/users/dangerer/following{/other_user}",
            "gists_url": "https://api.github.com/users/dangerer/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/dangerer/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/dangerer/subscriptions",
            "organizations_url": "https://api.github.com/users/dangerer/orgs",
            "repos_url": "https://api.github.com/users/dangerer/repos",
            "events_url": "https://api.github.com/users/dangerer/events{/privacy}",
            "received_events_url": "https://api.github.com/users/dangerer/received_events",
            "type": "User",
            "site_admin": false
        },
        "committer": {
            "login": "dangerer",
            "id": 1820610,
            "node_id": "MDQ6VXNlcjE4MjA2MTA=",
            "avatar_url": "https://avatars2.githubusercontent.com/u/1820610?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/dangerer",
            "html_url": "https://github.com/dangerer",
            "followers_url": "https://api.github.com/users/dangerer/followers",
            "following_url": "https://api.github.com/users/dangerer/following{/other_user}",
            "gists_url": "https://api.github.com/users/dangerer/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/dangerer/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/dangerer/subscriptions",
            "organizations_url": "https://api.github.com/users/dangerer/orgs",
            "repos_url": "https://api.github.com/users/dangerer/repos",
            "events_url": "https://api.github.com/users/dangerer/events{/privacy}",
            "received_events_url": "https://api.github.com/users/dangerer/received_events",
            "type": "User",
            "site_admin": false
        },
        "parents": [
            {
                "sha": "4959121631c7a3e2aa6515219c3c2757ebe4e1af",
                "url": "https://api.github.com/repos/gtn/exacomp/commits/4959121631c7a3e2aa6515219c3c2757ebe4e1af",
                "html_url": "https://github.com/gtn/exacomp/commit/4959121631c7a3e2aa6515219c3c2757ebe4e1af"
            }
        ],
        "stats": {
            "total": 4,
            "additions": 2,
            "deletions": 2
        },
        "files": [
            {
                "sha": "654e99cde401bd06c1e8c319292f4f76e00e221d",
                "filename": "lang/de/block_exacomp.js",
                "status": "modified",
                "additions": 1,
                "deletions": 1,
                "changes": 2,
                "blob_url": "https://github.com/gtn/exacomp/blob/8080598b181530e6402ba6f2dede69d11ef1b4e8/lang/de/block_exacomp.php",
                "raw_url": "https://github.com/gtn/exacomp/raw/8080598b181530e6402ba6f2dede69d11ef1b4e8/lang/de/block_exacomp.php",
                "contents_url": "https://api.github.com/repos/gtn/exacomp/contents/lang/de/block_exacomp.php?ref=8080598b181530e6402ba6f2dede69d11ef1b4e8",
                "patch": null
            },
            {
                "sha": "f1549285ff0e242e07fd687cddf2a1104b53c270",
                "filename": "lang/total.php",
                "status": "modified",
                "additions": 1,
                "deletions": 1,
                "changes": 2,
                "blob_url": "https://github.com/gtn/exacomp/blob/8080598b181530e6402ba6f2dede69d11ef1b4e8/lang/total.php",
                "raw_url": "https://github.com/gtn/exacomp/raw/8080598b181530e6402ba6f2dede69d11ef1b4e8/lang/total.php",
                "contents_url": "https://api.github.com/repos/gtn/exacomp/contents/lang/total.php?ref=8080598b181530e6402ba6f2dede69d11ef1b4e8",
                "patch": null
            }
        ]
    },
    {
        "sha": "4959121631c7a3e2aa6515219c3c2757ebe4e1af",
        "node_id": "MDY6Q29tbWl0NDk3MTcxMzo0OTU5MTIxNjMxYzdhM2UyYWE2NTE1MjE5YzNjMjc1N2ViZTRlMWFm",
        "commit": {
            "author": {
                "name": "Dietmar Angerer",
                "email": "uab.katzinger@gmail.com",
                "date": "2020-04-29T08:32:00Z"
            },
            "committer": {
                "name": "Dietmar Angerer",
                "email": "uab.katzinger@gmail.com",
                "date": "2020-04-29T08:32:00Z"
            },
            "message": "2 teachers of same course can add same example in there planing storage scheduler",
            "tree": {
                "sha": "25f9f63fffd557a30743e503de212de222ff3190",
                "url": "https://api.github.com/repos/gtn/exacomp/git/trees/25f9f63fffd557a30743e503de212de222ff3190"
            },
            "url": "https://api.github.com/repos/gtn/exacomp/git/commits/4959121631c7a3e2aa6515219c3c2757ebe4e1af",
            "comment_count": 0,
            "verification": {
                "verified": false,
                "reason": "unsigned",
                "signature": null,
                "payload": null
            }
        },
        "url": "https://api.github.com/repos/gtn/exacomp/commits/4959121631c7a3e2aa6515219c3c2757ebe4e1af",
        "html_url": "https://github.com/gtn/exacomp/commit/4959121631c7a3e2aa6515219c3c2757ebe4e1af",
        "comments_url": "https://api.github.com/repos/gtn/exacomp/commits/4959121631c7a3e2aa6515219c3c2757ebe4e1af/comments",
        "author": {
            "login": "dangerer",
            "id": 1820610,
            "node_id": "MDQ6VXNlcjE4MjA2MTA=",
            "avatar_url": "https://avatars2.githubusercontent.com/u/1820610?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/dangerer",
            "html_url": "https://github.com/dangerer",
            "followers_url": "https://api.github.com/users/dangerer/followers",
            "following_url": "https://api.github.com/users/dangerer/following{/other_user}",
            "gists_url": "https://api.github.com/users/dangerer/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/dangerer/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/dangerer/subscriptions",
            "organizations_url": "https://api.github.com/users/dangerer/orgs",
            "repos_url": "https://api.github.com/users/dangerer/repos",
            "events_url": "https://api.github.com/users/dangerer/events{/privacy}",
            "received_events_url": "https://api.github.com/users/dangerer/received_events",
            "type": "User",
            "site_admin": false
        },
        "committer": {
            "login": "dangerer",
            "id": 1820610,
            "node_id": "MDQ6VXNlcjE4MjA2MTA=",
            "avatar_url": "https://avatars2.githubusercontent.com/u/1820610?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/dangerer",
            "html_url": "https://github.com/dangerer",
            "followers_url": "https://api.github.com/users/dangerer/followers",
            "following_url": "https://api.github.com/users/dangerer/following{/other_user}",
            "gists_url": "https://api.github.com/users/dangerer/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/dangerer/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/dangerer/subscriptions",
            "organizations_url": "https://api.github.com/users/dangerer/orgs",
            "repos_url": "https://api.github.com/users/dangerer/repos",
            "events_url": "https://api.github.com/users/dangerer/events{/privacy}",
            "received_events_url": "https://api.github.com/users/dangerer/received_events",
            "type": "User",
            "site_admin": false
        },
        "parents": [
            {
                "sha": "4d43dbd8f470dadbba60e660270a74f187b6ceea",
                "url": "https://api.github.com/repos/gtn/exacomp/commits/4d43dbd8f470dadbba60e660270a74f187b6ceea",
                "html_url": "https://github.com/gtn/exacomp/commit/4d43dbd8f470dadbba60e660270a74f187b6ceea"
            }
        ],
        "stats": {
            "total": 7,
            "additions": 5,
            "deletions": 2
        },
        "files": [
            {
                "sha": "f804d1dd742e1b74d7c3baef3a13afb3cd7b3292",
                "filename": "lib/lib.php",
                "status": "modified",
                "additions": 5,
                "deletions": 2,
                "changes": 7,
                "blob_url": "https://github.com/gtn/exacomp/blob/4959121631c7a3e2aa6515219c3c2757ebe4e1af/lib/lib.php",
                "raw_url": "https://github.com/gtn/exacomp/raw/4959121631c7a3e2aa6515219c3c2757ebe4e1af/lib/lib.php",
                "contents_url": "https://api.github.com/repos/gtn/exacomp/contents/lib/lib.php?ref=4959121631c7a3e2aa6515219c3c2757ebe4e1af",
                "patch": null
            }
        ]
    }
];

console.log(debugData[0].files[0]);

function debugSwitchData() {
    debugIndex++;
    if(debugIndex >= debugData.length) debugIndex = 0;

    updateCommitDetails(debugData[debugIndex]);
}

let g;
let xscale;
let yscale;
let xaxis;
let g_xaxis;
let yaxis;
let g_yaxis;
function createCommitDetailsVis(visElement) {

    //create the description part (top) of the commit details
    const desc = visElement.append("div").attr("id", "cmt_desc");

    const btn = desc.append("button").text("Switch data")
                                    .attr("id", "btn");
    $('#btn').on('click', debugSwitchData);

    //create the part for the filetypes-graph (bottom) of the commit details
    const files = visElement.append("div").attr("id", "cmt_files"); 

    const svg = files.append("svg")
                .attr("id", "file_chart");
                //.attr("width", width)
                //.attr("height", height);

    const file_chart = $('#file_chart');
    const width = file_chart.width();
    const height = file_chart.height();
    const margin = { 
        top: parseFloat(file_chart.css('margin-top')), 
        bottom: parseFloat(file_chart.css('margin-top')), 
        left: parseFloat(file_chart.css('margin-top')), 
        right: parseFloat(file_chart.css('margin-top')) 
    };

    // Group used to enforce margin
    g = svg.append('g')
    .attr('transform', `translate(${margin.left},${margin.top})`);

    // Scales setup
    xscale = d3.scaleLinear().range([0, width]);
    yscale = d3.scaleBand().rangeRound([0, height]).paddingInner(0.1);

    // Axis setup
    xaxis = d3.axisTop().scale(xscale);
    g_xaxis = g.append('g').attr('class','x axis');
    yaxis = d3.axisLeft().scale(yscale);
    g_yaxis = g.append('g').attr('class','y axis');

    
}

function updateCommitDetails(new_commit) {
    const map = new Map();  // maps each file-type to its number of addtions and deletions
    
    //debugger
    //prepare data for visualizing
    new_commit.files.forEach((f) => {
        const dotIndex = f.filename.lastIndexOf(".");
        const ending = f.filename.substring(dotIndex + 1); //+1 because we don't need the .
        
        const old = map.get(ending);
        if(old) {   //update the existing entry
            old.additions += f.additions;
            old.deletions += f.deletions;
        } else {    //add a new entry for this filetype
            const entry = { 
                "type": ending,
                "additions": f.additions, 
                "deletions": f.deletions 
            };
            map.set(ending, entry);
        }
    });

    const parsed_data = [];
    for(const item of map.values()) {
        parsed_data.push(item);
        //const type = item.type;
        //const additions = item.additions;
        //const deletions = item.deletions;
        //console.log(type + ": +" + additions + ", -" + deletions);
    }
    //console.log(parsed_data);

    //create visualization
    //update the scales
    xscale.domain([0, d3.max(parsed_data, (d) => d.additions + d.deletions)]);
    yscale.domain(parsed_data.map((d) => d.type));
    //render the axis
    g_xaxis.transition().call(xaxis);
    g_yaxis.transition().call(yaxis);

    // Render the chart with new data

    // DATA JOIN use the key argument for ensurign that the same DOM element is bound to the same data-item
    const rect = g.selectAll('rect').data(parsed_data, (d) => d.type).join(
        // ENTER
        // new elements
        (enter) => {
          const rect_enter = enter.append('rect').attr('x', 0);
          rect_enter.append('title');
          return rect_enter;
        },
        // UPDATE
        // update existing elements
        (update) => update,
        // EXIT
        // elements that aren't associated with data
        (exit) => exit.remove()
        );

    // ENTER + UPDATE
    // both old and new elements
    rect.transition()
    .attr('height', yscale.bandwidth())
    .attr('width', (d) => xscale(d.additions + d.deletions))
    .attr('y', (d) => yscale(d.type));

    rect.select('title').text((d) => d.type);
}